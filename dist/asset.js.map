{"version":3,"sources":["../src/asset.js"],"names":["tellor","require","Datastore","datastore","PREDICTION_ASSETS","ASSETS","endPrizePeriod","startPrizePeriod","priceResults","loadTellorPrices","entities","assetDataResults","forEach","asset","index","assetKey","key","assetData","name","value","push","data","upsert","_getAssetEntities","assetKeys","map","Promise","resolve","reject","get","then","results","err","_percentChange","startPrice","latestPrice","priceDiff","updateAssetPrices","assetEntities","assetEntity","prizePeriodStartPrice","getAssetPrices","assetPrices","runQuery","createQuery"],"mappings":"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","sourcesContent":["import axios from \"axios\";\nimport { PSRs } from \"./utils/psr\";\nconst tellor = require('./lib/tellor');\nconst Datastore = require('@google-cloud/datastore');\n\n\n// Creates a client\nconst datastore = new Datastore();\n\nconst PREDICTION_ASSETS = [\"2\", \"1\", \"27\"]; // BTC, ETH, LINK\nconst ASSETS = [\"BTC\", \"ETH\", \"LINK\"];\n\nasync function endPrizePeriod() {\n  // TODO: call completeAward method on prize strategy contract\n}\n\nasync function startPrizePeriod() {\n\n    const priceResults = {}\n    await tellor.loadTellorPrices(priceResults, PREDICTION_ASSETS);\n    const entities = [];\n    const assetDataResults = [];\n    ASSETS.forEach((asset, index) => {\n\n      const assetKey = datastore.key(['AssetPrice', asset]);\n      const assetData = [\n        {\n          name: 'asset',\n          value: asset,\n        },\n        {\n          name: 'prizePeriodStartPrice',\n          value: priceResults[asset + \"/USD\"],\n        },\n        {\n          name: 'latestPrice',\n          value: priceResults[asset + \"/USD\"],\n        },\n        {\n          name: 'percentChange',\n          value: 0,\n        },\n      ];\n      assetDataResults.push(assetData);\n      entities.push({\n        key: assetKey,\n        data: assetData,\n      });\n\n    });\n\n    await datastore.upsert(entities);\n\n    return {\n      assetDataResults\n    }\n\n}\n\nasync function _getAssetEntities() {\n  const assetKeys = ASSETS.map(asset => datastore.key(['AssetPrice', asset]));\n  return new Promise((resolve, reject) => {\n    datastore.get(assetKeys).then((results, err) => {\n      results\n       ? resolve(results)\n       : reject(err);\n    });\n  });\n}\n\nfunction _percentChange(startPrice, latestPrice) {\n  const priceDiff = latestPrice - startPrice;\n  return priceDiff/startPrice * 100;\n}\n\nasync function updateAssetPrices() {\n\n    const assetEntities = await _getAssetEntities();\n    const priceResults = {}\n    await tellor.loadTellorPrices(priceResults, PREDICTION_ASSETS);\n\n\n    const entities = [];\n    const assetDataResults = [];\n    assetEntities[0].forEach((assetEntity, index) => {\n      const latestPrice = priceResults[assetEntity.asset + \"/USD\"];\n      const assetKey = datastore.key(['AssetPrice', assetEntity.asset]);\n      const assetData = [\n        {\n          name: 'asset',\n          value: assetEntity.asset,\n        },\n        {\n          name: 'prizePeriodStartPrice',\n          value: assetEntity.prizePeriodStartPrice,\n        },\n        {\n          name: 'latestPrice',\n          value: latestPrice,\n        },\n        {\n          name: 'percentChange',\n          value: _percentChange(assetEntity.prizePeriodStartPrice, latestPrice),\n        },\n      ];\n      //console.log(assetEntity, assetData);\n      assetDataResults.push(assetData);\n      entities.push({\n        key: assetKey,\n        data: assetData,\n      });\n\n    });\n\n    await datastore.upsert(entities);\n\n    return {\n      assetDataResults\n    }\n\n}\n\nasync function getAssetPrices() {\n  const [assetPrices] = await datastore.runQuery(\n    datastore.createQuery('AssetPrice')\n  );\n  return assetPrices;\n}\n\n\n export {\n     startPrizePeriod, endPrizePeriod, updateAssetPrices, getAssetPrices\n };\n"],"file":"asset.js"}